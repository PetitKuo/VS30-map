<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS30 即時定位地圖 (OSM 版)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        body, html { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100%; width: 100%; }
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000; /* Leaflet 的地圖層級較高，這裡設定 1000 確保面板在最上層 */
            width: 80%;
            max-width: 300px;
        }
        .vs30-value { font-size: 24px; font-weight: bold; color: #d32f2f; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="info-panel">
        <div>目前的 VS30 數值：</div>
        <div class="vs30-value" id="vs30-display">定位中...</div>
        <div id="distance-display" style="font-size: 14px; color: #666; margin-top: 8px;"></div>
    </div>

    <script>
        let map;
        let userMarker;
        let vs30Data;

        // 1. 初始化 Leaflet 地圖
        function initMap() {
            // 設定地圖中心點 (緯度, 經度) 與縮放級別
            map = L.map('map').setView([24.9605, 121.2239], 14);

            // 加入 OpenStreetMap 的圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // 2. 載入 VS30 GeoJSON 資料
            fetch('Z10.geojson')
                .then(response => response.json())
                .then(data => {
                    vs30Data = data; // 存入變數供 Turf.js 計算
                    // 載入成功後，啟動定位
                    startTracking();
                })
                .catch(error => console.error("無法載入資料:", error));
        }

        // 3. 啟動手機定位追蹤
        function startTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Leaflet 更新標記的寫法
                        if (!userMarker) {
                            // 畫一個藍色的圓點代表使用者
                            userMarker = L.circleMarker([lat, lng], {
                                radius: 8,
                                fillColor: "#4285F4",
                                color: "#ffffff",
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 1
                            }).addTo(map);
                            
                            // 將地圖視角移動到目前位置
                            map.setView([lat, lng], 15); 
                        } else {
                            // 若標記已存在，只更新位置
                            userMarker.setLatLng([lat, lng]);
                        }

                        // 計算 VS30 與距離
                        checkVs30Value(lng, lat);
                    },
                    (error) => {
                        document.getElementById("vs30-display").innerText = "定位失敗";
                        console.error("Geolocation error:", error);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert("你的瀏覽器不支援地理位置功能。");
            }
        }

        // 4. 計算距離與數值 (保留你上一次修改成功的完美版本)
        function checkVs30Value(lng, lat) {
            if (!vs30Data) return;

            const userPoint = turf.point([lng, lat]);
            const nearestFeature = turf.nearestPoint(userPoint, vs30Data);

            if (nearestFeature) {
                const vs30 = nearestFeature.properties.Field4; 
                const distanceKm = turf.distance(userPoint, nearestFeature, {units: 'kilometers'});
                const distanceMeters = Math.round(distanceKm * 1000);
                
                if (distanceKm > 1) {
                    document.getElementById("vs30-display").innerText = "所在位置無資料";
                    document.getElementById("distance-display").innerText = "";
                } else {
                    document.getElementById("vs30-display").innerText = vs30 + " m/s";
                    document.getElementById("distance-display").innerText = "距格點中心約 " + distanceMeters + " 公尺";
                }
            }
        }

        // 網頁載入完成後自動執行 initMap
        window.onload = initMap;
    </script>
</body>
</html>